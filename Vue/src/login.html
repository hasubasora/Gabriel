<html>

<head>
    @@include('include/header.html')
    <script>
        const sendCodeUrl = "${base}/qrCode/send",
            invitationUrl = "${base}/qrCode/check",
            phoneUrl = "${base}/qrCode/checkPhone",
            codeUrl = "${base}/qrCode/isCheck",
            inviteR = "${base}/qrCode/inviteR";
    </script>
    <title>注册</title>
</head>

<body>
    <header>
        <div class="tag">
            <span class="tag-left on">新用户注册</span>
            <span class="tag-right">登&nbsp;录</span>
        </div>
    </header>
    <section class="tag-text">
        <div class="tel">
            <span class="tel-dist inputR">
                +86
            </span>
            <input type="tel" name="tel" id="tel" class="inputR2" placeholder='手机号' maxlength="11">
        </div>
        <div class="code">
            <input type="tel" name="tel" id="code">
            <a href="javascript:void(0);" id="qcCode">获取验证码</a>
            <a href="javascript:void(0);" class="qcCode1"></a>

            <input type="button" value="下一步" class="next-tab disabled" disabled='disabled'>
        </div>
    </section>
    <section class="tag-text" style="display:none">
        <div class="invitation">
            <input type="tel" name="invitation" class="phoneinput" id="phone" placeholder="手机号" maxlength="11">
            <input type="password" name="pwd" class="phoneinput margintop" id="pwd" placeholder="密码">
            <input type="button" value="登&nbsp;录" class="next-tab2 disabled" disabled='disabled'>
        </div>
    </section>
</body>


<script>
    $(function() {
        login.init();

    })
    const login = {

        init() {
            _t = this;
            //切换 
            $('.tag span').on('click', function() {
                _index = $(this).index();
                $(this).addClass('on').siblings('span').removeClass('on');
                $('.tag-text').eq(_index).fadeIn().siblings('.tag-text').hide();
            });

            //获取验证码
            $('#qcCode').on('click', function() {
                _t.codetime();
            });



            var fige = 0;
            var make = 0;
            var dots = 0,
                dots2 = 0;
            $(document).on('keyup', function(event) {
                event = event || window.event;
                var el = event.target || event.srcElement;
                // alert(el.id)
                // 登录页面
                if (el.id == 'phone') {
                    $('#phone').val() ? make = 1 : make = 0;
                }
                if (el.id == 'pwd') {
                    $('#pwd').val() ? fige = 1 : fige = 0;
                }
                _t.dockeyup(make, fige, $('.next-tab2'));
                // if (fige == 1 && make == 1) {
                //     $('.next-tab2').removeClass('disabled').removeAttr('disabled');
                // } else {
                //     $('.next-tab2').addClass('disabled').attr('disabled', 'disabled');
                // }

                //注册页面
                if (el.id == 'tel') {
                    $('#tel').val() ? dots = 1 : dots = 0;
                }
                if (el.id == 'code') {
                    $('#code').val() ? dots2 = 1 : dots2 = 0;
                }
                _t.dockeyup(dots, dots2, $('.next-tab'));

                // if (dots == 1 && dots2 == 1) {
                //     $('.next-tab').removeClass('disabled').removeAttr('disabled');
                // } else {
                //     $('.next-tab').addClass('disabled').attr('disabled', 'disabled');
                // }


            });
            //下一步 注册
            $('.next-tab').on('click', function() {
                if (_t.codetime()) {
                    _t.verifyCode($('#code').val(), $('#tel').val())
                } else {
                    return false;
                }

            });

            //下一步 登录
            $('.next-tab2').on('click', function() {

                _t.login($('#phone').val(), $('#pwd').val());
            });

        },
        dockeyup(d1, d2, d3) {
            if (d1 == 1 && d2 == 1) {
                d3.removeClass('disabled').removeAttr('disabled');
            } else {
                d3.addClass('disabled').attr('disabled', 'disabled');
            }

        },
        codetime() {
            if (!$('#tel').val()) {
                layer.open({
                    content: '输入手机号',
                    skin: 'msg',
                    time: 2 //2秒后自动关闭
                });
                return false;
            } else if ($('#tel').val().length < 11) {
                layer.open({
                    content: '输入正确手机号',
                    skin: 'msg',
                    time: 2 //2秒后自动关闭
                });
                return false;
            }
            if ($('#tel').val().length == 11) {
                console.log(_t.verifyPhone($('#tel').val()));
                console.log($('#tel').val());
                if (_t.verifyPhone($('#tel').val())) {
                    $('#tel').attr('disabled', 'disabled');
                    _t.qcCode($('#qcCode'));
                    _t.sendCode($('#tel').val());
                    return true;
                } else {
                    layer.open({
                        content: '输入正确手机号',
                        skin: 'msg',
                        time: 2 //2秒后自动关闭
                    });
                    return false;
                }
            }
        },
        /**
         * 发送验证码
         */
        sendCode(tel) {
            $.ajax({
                url: sendCodeUrl, //发送验证码
                type: 'post',
                dataType: 'json',
                data: {
                    phone: tel
                },
                success: function(result) {
                    if (result.status == 1) {
                        //验证成功再发送验证码 返回true  跳转下一步
                        layer.open({
                            content: '发送成功',
                            skin: 'msg',
                            time: 2 //2秒后自动关闭
                        });

                        return true;
                    } else if (result.status == 0) {
                        layer.open({
                            content: '发送失败',
                            skin: 'msg',
                            time: 2 //2秒后自动关闭
                        });

                        //返回false
                        return false;

                    }
                },
                error: function() {

                    layer.open({
                        content: '你进入了没有网络的异次元世界！',
                        skin: 'msg',
                        time: 2 //2秒后自动关闭
                    });

                    return false;
                }
            })
        },


        //获取验证码
        qcCode(obj) {
            $('.qcCode1').css('width', '122px');
            var a = 60;
            var timer = setInterval(function() {
                if (a > 0) {
                    obj.text("(" + a + ")");
                    a--;
                } else {
                    clearInterval(timer);
                    obj.text("获取验证码");
                    $('.qcCode1').css('width', '0');
                    $('#tel').removeAttr('disabled');
                    a = 60;
                }
            }, 1000);
        },


        verifyCode(code, phone) { //验证 验证码
            $.ajax({
                url: codeUrl, //验证码存在的地址
                type: 'post',
                dataType: 'json',
                data: {
                    code: code,
                    phone: phone
                },
                success: function(result) {
                    if (result.status == 1) {
                        //验证成功再发送验证码 返回true  跳转下一步
                        return true;

                    } else if (result.status == 0) {
                        //返回false
                        return false;

                    } else if (result.status == 2) {
                        alert("验证错误")
                        return false;
                    }
                },
                error: function() {
                    layer.open({
                        content: '你进入了没有网络的异次元世界！',
                        skin: 'msg',
                        time: 2 //2秒后自动关闭
                    });
                    return false;
                }
            })
        },


        verifyPhone(tel) { //检测输入的手机号是否正确
            const reg = /^0?1[3|4|5|7|8][0-9]\d{8}$/;
            if (reg.test(tel)) {
                return true;
            }
            return false;
        },


        verifyTel(tel) { //验证手机号存在否
            $.ajax({
                url: phoneUrl, //手机号存在的地址
                type: 'post',
                dataType: 'json',
                data: {
                    phone: tel
                },
                success: function(result) {
                    if (result.status == 1) {
                        //验证成功再发送验证码 返回true
                        return true;
                    } else if (result.status == 0) {
                        //返回false
                        return false;
                    }
                },
                error: function() {
                    layer.open({
                        content: '你进入了没有网络的异次元世界！',
                        skin: 'msg',
                        time: 2 //2秒后自动关闭
                    });
                    return false;
                }
            })

        },


        login(y, x) {

            $.ajax({
                url: invitationUrl,
                type: 'post',
                dataType: 'json',
                data: {
                    username: y,
                    password: x
                },
                success: function(result) {
                    //   console.log(result.ret)
                    if (result.ret == 1) {
                        window.location.href = inviteR + "?code=" + $('#invitation').val();
                    }
                    if (result.ret == 0) {
                        layer.open({
                            content: '你输入的密码和账户不匹配',
                            skin: 'msg',
                            time: 2 //2秒后自动关闭
                        });
                        return false;
                    }
                },
                error: function() {
                    layer.open({
                        content: '你进入了没有网络的异次元世界！',
                        skin: 'msg',
                        time: 2 //2秒后自动关闭
                    });
                    return false;
                }
            })
        },






    }
</script>

</html>